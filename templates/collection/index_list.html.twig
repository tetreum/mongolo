{% extends isAjax ? "common/ajaxbase.html.twig" : "common/base.html.twig" %}

{% block content %}
<h2>Index list</h2>

<button data-action="show-create-form">New</button>
<div id="create-index-form" class="box">
    <form method="post">
        <label>Name: <input name="name" type="text"></label>
        Fields:
        <ul>
        </ul>
        <button data-action="add-field">+</button>
        <label>Unique: <input name="unique" type="checkbox"></label>
        <button>Create</button>
    </form>
</div>
<table class="index-list">
  <tr>
    <th>Name</th>
    <th>Fields</th> 
    <th>Type</th>
    <th>Options</th>
  </tr>
    {% for entry in indexes %}
  <tr>
    <td>{{ entry.name }}</td>
    <td><pre>{{ entry.fields }}</pre></td>
    <td>{{ entry.type }}</td>
    <td><span class="red-link" data-action="delete">Delete</span></td>
  </tr>
    {% endfor %}
</table>
<template id="tpl-index-field">
    <li>
        <input name="fields[]" type="text">
        <select name="order[]"><option value="1">asc</option><option value="-1">desc</option><option value="2dsphere">2dsphere</option></select>
    </li>
</template>
{% endblock %}
{% block bottomJS %}
<script>
    $(function() {
        $('[data-action=show-create-form]').on("click", function () {
            $('#create-index-form').show();
        });
        $('[data-action=add-field]').on("click", function () {
            var $template = mongolo.utils.getTemplate("index-field");
            $('#create-index-form ul').prepend($template);
        });
        $('[data-action=delete]').on("click", function () {
            mongolo.navigation.showConfirm("Â¿Do you wanna delete this index?", function () {
                mongolo.api("index/delete", {db: $_GET("db"), collection: $_GET("collection"), name: name}, function (data) {
                    if (data.error > 0) {
                        return false;
                    }
                    
                });
            });
        });
        $('#create-index-form form').on("submit", function (e)
        {
            e.preventDefault();

            var name = $('[name=name]').val(),
                sortList = $("[name='fields[]'"),
                sortOrderList = $("[name='order[]'"),
                unique = $('[name="unique"]').is(":checked"),
                fields = {};

                while (i < sortList.length) {
                    var row = $(sortList[i]).val();
                    if (row) {
                        sort[row] = $(sortOrderList[i]).val();
                    }
                    i++;
                }

            mongolo.api("index/create", {db: $_GET("db"), collection: $_GET("collection"), name: name, fields: fields, unique: unique}, function (data) {
                if (data.error > 0) {
                    return false;
                }
                mongolo.navigation.reload();
            });
        });
    });
</script>
{% endblock %}
